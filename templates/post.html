<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Page</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Your CSS styles here */
        .map {
            height: 400px; /* Adjust map height as needed */
            width: 100%; /* Full width */
        }
    </style>
</head>
<body>
    {% for post in posts %}
    <div class="post-container" id="post{{ post.id }}">
        <div class="post-title">
            <img src="{{ post.uploaded_by.userprofile.profile_picture.url }}" alt="user picture">
            <ul>
                <li><h3>{{ post.uploaded_by }}</h3></li>
                <li><span>{{ post.uploaded_at }}</span></li>
            </ul>
            {% if post.lim == 'no' or post.lim == 'new' %}
            <div>
                <span style="font-weight: bold; display: block; margin-bottom: 5px;">{{ post.title }}</span>
                <span>{{ post.description }}</span>
            </div>
            {% else %}
            <p>Explicit</p>
            {% endif %}
        </div>

        {% if post.file_type == 'gallery' %}
            {% if post.lim == 'no' %}
            <div class="post-images">
                <img src="{{ post.image.url }}" alt="{{ post.title }}" style="height:400px; width:100%;" class="double-tap-to-like">
            </div>
            {% elif post.lim == 'yes' %}
            <div class="post-images">
                <a href="{% url 'video' id=post.id %}" >Explicit Content</a>
            </div>
            {% endif %}
        {% elif post.file_type == 'video' %}
            {% if post.lim == 'no' %}
            <video src="{{ post.video.url }}" controls style="height:400px;" class="double-tap-to-like"></video>
            {% elif post.lim == 'yes' %}
            <div class="post-images">
                <a href="{% url 'video' id=post.id %}" >Explicit Content</a>
            </div>
            {% endif %}
        {% elif post.file_type == 'location' %}
            <!-- Display the location on the map -->
            <div id="map{{ post.id }}" class="map"></div>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    var location = "{{ post.location }}".split(',');
                    var latitude = parseFloat(location[0]);
                    var longitude = parseFloat(location[1]);
                    var map{{ post.id }} = L.map('map{{ post.id }}').setView([latitude, longitude], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map{{ post.id }});
                    // Optionally, add a marker at the location
                    L.marker([latitude, longitude]).addTo(map{{ post.id }})
                        .bindPopup("{{ post.title }}")
                        .openPopup();
                });
            </script>
        {% endif %}

        <div class="post-interactions">
            <ul>
                <li>
                    <button class="like-btn" data-post-id="{{ post.id }}" id="likeBtn{{ post.id }}">
                        <span class="heart" id="heartIcon{{ post.id }}">
                            <i class="fa fa-heart" id="likeIcon{{ post.id }}" style="color: {% if post.has_liked %}red{% else %}dbe1d9{% endif %};"></i>
                        </span>
                        <span class="like-count" id="likeCount{{ post.id }}">{{ post.likes.count }}</span> Likes
                    </button>
                </li>
                <li>
                    <button class="view-comments-btn" data-post-id="{{ post.id }}">View Comments</button>
                </li>
            </ul>
        </div>
        <div class="comment-field">
            <input type="text" placeholder="Write a comment..." id="commentInput{{ post.id }}">
            <button class="add-comment-btn" data-post-id="{{ post.id }}"><i class="fa fa-paper-plane"></i></button>
        </div>
        <div class="comments-section" id="commentsSection{{ post.id }}" style="display: none;">
            <!-- Comments for this post -->
            {% for comment in post.comments.all %}
            <div class="comment">
                <img src="{{ comment.user.userprofile.profile_picture.url }}" alt="commenter profile image">
                <p>{{ comment.content }}</p>
                <div class="comment-interactions">
                    <span class="comment-like-btn">Like</span>
                    <span class="comment-reply-btn">Reply</span>
                </div>
            </div>
            <!-- Replies for each comment -->
            {% for reply in comment.replies.all %}
            <div class="comment comment-reply">
                <img src="{{ reply.user.userprofile.profile_picture.url }}" alt="replier profile image">
                <p>{{ reply.content }}</p>
                <div class="comment-interactions">
                    <span class="comment-like-btn">Like</span>
                    <span class="comment-reply-btn">Reply</span>
                </div>
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            // Function to get the CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            // Like a post
            $('.like-btn').click(function(){
                const postId = $(this).data('post-id');
                const likeIcon = $(`#heartIcon${postId} i`);
                $.ajax({
                    url: `/like/${postId}/`,
                    type: 'GET',
                    success: function(data){
                        $(`#likeCount${postId}`).text(data.like_count);
                        // Toggle the color of the heart icon
                        if (likeIcon.css('color') === 'rgb(255, 0, 0)') { // red
                            likeIcon.css('color', 'white');
                        } else {
                            likeIcon.css('color', 'red');
                        }
                    }
                });
            });

            // View comments
            $('.view-comments-btn').click(function(){
                const postId = $(this).data('post-id');
                const commentsSection = $(`#commentsSection${postId}`);
                // Toggle comments section visibility
                commentsSection.toggle();
                // Load comments if not already loaded
                if (commentsSection.is(':visible') && commentsSection.children().length === 0) {
                    $.ajax({
                        url: `/get_comments/${postId}/`,
                        type: 'GET',
                        success: function(data){
                            commentsSection.html(data.comments_html);
                        }
                    });
                }
            });

            // Add comment
            $('.add-comment-btn').click(function(){
                const postId = $(this).data('post-id');
                const commentInput = $(`#commentInput${postId}`);
                const commentText = commentInput.val().trim();
                if (commentText !== '') {
                    $.ajax({
                        url: `/add_comment/${postId}/`,
                        type: 'POST',
                        data: {
                            'content': commentText,
                            'csrfmiddlewaretoken': csrftoken
                        },
                        success: function(data){
                            if (data.success) {
                                // Clear input and append new comment
                                commentInput.val('');
                                $(`#commentsSection${postId}`).append(data.comment_html);
                            } else {
                                alert('Error: Unable to add comment.');
                            }
                        }
                    });
                }
            });
        });
    </script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</body>
</html>
